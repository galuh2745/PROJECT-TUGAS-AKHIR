generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                  BigInt    @id @default(autoincrement())
  name                String    @db.VarChar(255)
  email               String?   @unique @db.VarChar(255)
  password            String    @db.VarChar(255)
  role                Role      @default(USER)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  need_password_reset Boolean   @default(false)
  reset_requested_at  DateTime?
  karyawan            Karyawan?

  @@map("users")
}

model JenisKaryawan {
  id                  BigInt     @id @default(autoincrement())
  nama_jenis          String     @db.VarChar(255)
  jam_masuk           DateTime   @db.Time(0)
  jam_pulang          DateTime   @db.Time(0)
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt
  toleransi_terlambat Int        @default(15)
  is_shift_malam      Boolean    @default(false)
  skip_jam_kerja      Boolean    @default(false)
  karyawan            Karyawan[]

  @@map("jenis_karyawan")
}

model Karyawan {
  id                BigInt         @id @default(autoincrement())
  user_id           BigInt         @unique
  nip               String         @unique @db.VarChar(50)
  nama              String         @db.VarChar(255)
  jenis_karyawan_id BigInt
  no_hp             String         @db.VarChar(20)
  alamat            String         @db.Text
  foto_profil       String?        @db.VarChar(500)
  status            StatusKaryawan @default(AKTIF)
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  absensi           Absensi[]
  izin_cuti         IzinCuti[]
  jenis_karyawan    JenisKaryawan  @relation(fields: [jenis_karyawan_id], references: [id])
  user              User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  lembur            Lembur[]

  @@index([user_id])
  @@index([jenis_karyawan_id])
  @@map("karyawan")
}

model Absensi {
  id          BigInt        @id @default(autoincrement())
  karyawan_id BigInt
  tanggal     DateTime      @db.Date
  jam_masuk   DateTime?     @db.Time(0)
  jam_pulang  DateTime?     @db.Time(0)
  status      StatusAbsensi
  latitude    Decimal?      @db.Decimal(10, 8)
  longitude   Decimal?      @db.Decimal(11, 8)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
  foto_masuk  String?       @db.VarChar(500)
  foto_pulang String?       @db.VarChar(500)
  karyawan    Karyawan      @relation(fields: [karyawan_id], references: [id], onDelete: Cascade)

  @@index([karyawan_id])
  @@index([tanggal])
  @@map("absensi")
}

model IzinCuti {
  id              BigInt         @id @default(autoincrement())
  karyawan_id     BigInt
  jenis           JenisIzinCuti
  tanggal_mulai   DateTime       @db.Date
  tanggal_selesai DateTime       @db.Date
  alasan          String         @db.Text
  status          StatusIzinCuti @default(PENDING)
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt
  karyawan        Karyawan       @relation(fields: [karyawan_id], references: [id], onDelete: Cascade)

  @@index([karyawan_id])
  @@map("izin_cuti")
}

model Lembur {
  id          BigInt   @id @default(autoincrement())
  karyawan_id BigInt
  tanggal     DateTime @db.Date
  jam_mulai   DateTime @db.Time(0)
  jam_selesai DateTime @db.Time(0)
  total_jam   Decimal  @db.Decimal(4, 2)
  keterangan  String   @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  karyawan    Karyawan @relation(fields: [karyawan_id], references: [id], onDelete: Cascade)

  @@index([karyawan_id])
  @@map("lembur")
}

model AyamMati {
  id            BigInt           @id @default(autoincrement())
  perusahaan_id BigInt
  tanggal       DateTime         @db.Date
  jumlah_ekor   Int
  keterangan    String?          @db.Text
  status_claim  StatusClaim
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt
  perusahaan    Perusahaan       @relation(fields: [perusahaan_id], references: [id], onDelete: Cascade)

  @@index([perusahaan_id])
  @@index([tanggal])
  @@map("ayam_mati")
}

model BarangKeluarAyamHidup {
  id              BigInt     @id @default(autoincrement())
  perusahaan_id   BigInt
  tanggal         DateTime   @db.Date
  nama_customer   String     @db.VarChar(255)
  jumlah_ekor     Int
  total_kg        Decimal    @db.Decimal(10, 2)
  jenis_daging    String     @default("BESAR") @db.VarChar(10)
  harga_per_kg    Decimal    @db.Decimal(12, 2)
  is_bubut        Boolean    @default(false)
  harga_bubut     Decimal    @default(0.00) @db.Decimal(12, 2)
  total_penjualan Decimal    @db.Decimal(15, 2)
  pengeluaran     Decimal    @default(0.00) @db.Decimal(15, 2)
  keterangan      String?    @db.Text
  total_bersih    Decimal    @default(0.00) @db.Decimal(15, 2)
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt
  perusahaan      Perusahaan @relation(fields: [perusahaan_id], references: [id], onDelete: Cascade)

  @@index([perusahaan_id])
  @@index([tanggal])
  @@map("barang_keluar_ayam_hidup")
}

model BarangKeluarDaging {
  id                          BigInt                       @id @default(autoincrement())
  perusahaan_id               BigInt?
  tanggal                     DateTime                     @db.Date
  nama_customer               String                       @db.VarChar(255)
  total_penjualan             Decimal                      @default(0.00) @db.Decimal(15, 2)
  pengeluaran                 Decimal                      @default(0.00) @db.Decimal(15, 2)
  saldo                       Decimal                      @default(0.00) @db.Decimal(15, 2)
  keterangan                  String?                      @db.Text
  created_at                  DateTime                     @default(now())
  updated_at                  DateTime                     @updatedAt
  perusahaan                  Perusahaan?                  @relation(fields: [perusahaan_id], references: [id])
  details                     BarangKeluarDagingDetail[]

  @@index([perusahaan_id])
  @@index([tanggal])
  @@map("barang_keluar_daging")
}

model BarangKeluarDagingDetail {
  id                      BigInt              @id @default(autoincrement())
  barang_keluar_daging_id BigInt
  jenis_daging_id         BigInt
  berat_kg                Decimal             @db.Decimal(10, 2)
  harga_per_kg            Decimal             @db.Decimal(15, 2)
  subtotal                Decimal             @db.Decimal(15, 2)
  created_at              DateTime            @default(now())
  barang_keluar_daging    BarangKeluarDaging  @relation(fields: [barang_keluar_daging_id], references: [id], onDelete: Cascade)
  jenis_daging            JenisDaging         @relation(fields: [jenis_daging_id], references: [id])

  @@index([barang_keluar_daging_id])
  @@index([jenis_daging_id])
  @@map("barang_keluar_daging_detail")
}

model BarangMasuk {
  id                 BigInt     @id @default(autoincrement())
  perusahaan_id      BigInt
  nomor_do           String?    @db.VarChar(100)
  tanggal_masuk      DateTime   @db.Date
  jumlah_ekor        Int
  total_kg           Decimal    @db.Decimal(10, 2)
  bw                 Decimal    @db.Decimal(6, 3)
  harga_per_kg       Decimal    @db.Decimal(12, 2)
  total_harga        Decimal    @db.Decimal(15, 2)
  tanggal_pembayaran DateTime?  @db.Date
  jumlah_transfer    Decimal    @default(0.00) @db.Decimal(15, 2)
  saldo_kita         Decimal    @db.Decimal(15, 2)
  nama_kandang       String     @db.VarChar(255)
  alamat_kandang     String?    @db.Text
  no_mobil           String?    @db.VarChar(50)
  nama_supir         String?    @db.VarChar(255)
  created_at         DateTime   @default(now())
  updated_at         DateTime   @updatedAt
  perusahaan         Perusahaan @relation(fields: [perusahaan_id], references: [id], onDelete: Cascade)

  @@index([perusahaan_id])
  @@index([tanggal_masuk])
  @@map("barang_masuk")
}

model JenisDaging {
  id                          BigInt                        @id @default(autoincrement())
  nama_jenis                  String                        @db.VarChar(100)
  aktif                       Boolean                       @default(true)
  created_at                  DateTime                      @default(now())
  updated_at                  DateTime                      @updatedAt
  barang_keluar_daging_detail BarangKeluarDagingDetail[]

  @@map("jenis_daging")
}

model Perusahaan {
  id                       BigInt                      @id @default(autoincrement())
  nama_perusahaan          String                      @db.VarChar(255)
  alamat                   String?                     @db.Text
  kontak                   String?                     @db.VarChar(100)
  created_at               DateTime                    @default(now())
  updated_at               DateTime                    @updatedAt
  ayam_mati                AyamMati[]
  barang_keluar_ayam_hidup BarangKeluarAyamHidup[]
  barang_keluar_daging     BarangKeluarDaging[]
  barang_masuk             BarangMasuk[]

  @@map("perusahaan")
}

enum Role {
  ADMIN
  OWNER
  USER
}

enum StatusKaryawan {
  AKTIF
  NONAKTIF
}

enum StatusAbsensi {
  HADIR
  TERLAMBAT
  ALPHA
  IZIN
  CUTI
}

enum JenisIzinCuti {
  IZIN
  CUTI
  SAKIT
}

enum StatusIzinCuti {
  PENDING
  APPROVED
  REJECTED
}

enum StatusClaim {
  BISA_CLAIM
  TIDAK_BISA

  @@map("ayam_mati_status_claim")
}

// ==================== PIUTANG SYSTEM ====================

model Customer {
  id            BigInt              @id @default(autoincrement())
  nama          String              @db.VarChar(255)
  no_hp         String?             @db.VarChar(50)
  alamat        String?             @db.Text
  created_at    DateTime            @default(now())
  penjualan     Penjualan[]
  pembayaran    PembayaranPiutang[]

  @@map("customers")
}

model Penjualan {
  id                BigInt   @id @default(autoincrement())
  nomor_nota        String?  @unique @db.VarChar(50)
  customer_id       BigInt
  tanggal           DateTime @db.Date
  jenis_transaksi   String   @default("MANUAL") @db.VarChar(20) // AYAM_HIDUP / DAGING / MANUAL
  total_penjualan   Decimal  @db.Decimal(15, 2)
  pengeluaran       Decimal  @default(0) @db.Decimal(15, 2)
  grand_total       Decimal  @db.Decimal(15, 2)
  jumlah_bayar      Decimal  @default(0) @db.Decimal(15, 2)
  sisa_piutang      Decimal  @default(0) @db.Decimal(15, 2)
  status            String   @default("draft") @db.VarChar(20) // draft / lunas / sebagian / hutang
  status_cetak      Boolean  @default(false)
  metode_pembayaran String?  @db.VarChar(20) // CASH / TRANSFER / CAMPUR
  keterangan        String?  @db.Text
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  customer          Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  detail            PenjualanDetail[]
  pembayaran        PembayaranPiutang[]
  pembayaran_log    PembayaranLog[]

  @@index([customer_id])
  @@index([tanggal])
  @@map("penjualan")
}

model PembayaranLog {
  id            BigInt   @id @default(autoincrement())
  penjualan_id  BigInt
  total_lama    Decimal  @db.Decimal(15, 2)
  bayar_lama    Decimal  @db.Decimal(15, 2)
  sisa_lama     Decimal  @db.Decimal(15, 2)
  bayar_baru    Decimal  @db.Decimal(15, 2)
  sisa_baru     Decimal  @db.Decimal(15, 2)
  alasan        String   @db.Text
  diubah_oleh   String   @db.VarChar(255)
  created_at    DateTime @default(now())

  penjualan     Penjualan @relation(fields: [penjualan_id], references: [id], onDelete: Cascade)

  @@index([penjualan_id])
  @@map("pembayaran_log")
}

model PenjualanDetail {
  id              BigInt    @id @default(autoincrement())
  penjualan_id    BigInt
  tipe            String?   @db.VarChar(20)  // ayam_hidup | daging
  jenis_daging    String?   @db.VarChar(100)
  ekor            Int?
  berat           Decimal   @db.Decimal(10, 2)
  harga           Decimal   @db.Decimal(15, 2)
  subtotal        Decimal   @db.Decimal(15, 2)

  penjualan       Penjualan @relation(fields: [penjualan_id], references: [id], onDelete: Cascade)

  @@index([penjualan_id])
  @@map("penjualan_detail")
}

model PembayaranPiutang {
  id            BigInt      @id @default(autoincrement())
  customer_id   BigInt
  penjualan_id  BigInt?
  tanggal       DateTime    @db.Date
  jumlah_bayar  Decimal     @db.Decimal(15, 2)
  metode        String      @db.VarChar(20) // CASH / TRANSFER
  keterangan    String?     @db.Text
  created_at    DateTime    @default(now())

  customer      Customer    @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  penjualan     Penjualan?  @relation(fields: [penjualan_id], references: [id])

  @@index([customer_id])
  @@index([penjualan_id])
  @@index([tanggal])
  @@map("pembayaran_piutang")
}
